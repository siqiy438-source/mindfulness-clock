<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒçµèŠ±å›­ | Mind Garden</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        forest: '#2F5233',
                        mint: '#B4F8C8',
                        sage: '#A0E7E5',
                        accent: '#FFAEBC',
                        card: 'rgba(255, 255, 255, 0.8)'
                    },
                    fontFamily: {
                        sans: ['Nunito', 'sans-serif'],
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'float-delayed': 'float 6s ease-in-out 3s infinite',
                        'pulse-gentle': 'pulse-gentle 4s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        'pulse-gentle': {
                            '0%, 100%': { opacity: 0.6, transform: 'scale(1)' },
                            '50%': { opacity: 1, transform: 'scale(1.1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(180deg, #E0F8E0 0%, #F5FFF5 100%);
        }
        
        .breathing-circle-container {
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .breathing-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #B4F8C8 0%, #A0E7E5 100%);
            box-shadow: 0 0 40px rgba(160, 231, 229, 0.4);
            position: absolute;
            transition: all 4s ease-in-out; /* å…³é”®ï¼šå¹³æ»‘çš„å‘¼å¸åŠ¨ç”» */
            transform: scale(1);
        }

        /* å‘¼å¸çŠ¶æ€ */
        .inhale .breathing-circle { transform: scale(1.6); opacity: 0.9; }
        .hold .breathing-circle { transform: scale(1.6); opacity: 0.9; }
        .exhale .breathing-circle { transform: scale(1); opacity: 0.7; }
        
        .circle-text {
            position: relative;
            z-index: 10;
            font-size: 1.5rem;
            color: #2F5233;
            font-weight: 800;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #CBD5E1;
            transition: all 0.3s;
        }
        .step-dot.active {
            background-color: #FFAEBC;
            transform: scale(1.4);
        }
        .step-line {
            flex: 1;
            height: 2px;
            background-color: #E2E8F0;
        }
        
        .deco-cloud { position: absolute; fill: #fff; opacity: 0.6; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
        .deco-leaf { position: absolute; fill: #B4F8C8; opacity: 0.8; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center overflow-hidden relative text-forest">

    <audio id="bgMusic" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=relaxing-music-vol1-124477.mp3" type="audio/mpeg">
    </audio>

    <svg class="deco-cloud animate-float top-10 left-10 w-24" viewBox="0 0 24 24"><path d="M17.5,19c-3.037,0-5.5-2.463-5.5-5.5c0-0.34,0.032-0.671,0.091-0.994C11.365,11.594,10.12,11,8.75,11c-2.485,0-4.5,2.015-4.5,4.5s2.015,4.5,4.5,4.5h8.75c2.485,0,4.5-2.015,4.5-4.5s-2.015-4.5-4.5-4.5c-0.377,0-0.739,0.048-1.085,0.136C16.142,8.966,14.07,7.5,11.5,7.5c-3.037,0-5.5,2.463-5.5,5.5c0,0.34-0.032,0.671-0.091,0.994C5.165,12.594,4.12,12,2.75,12C0.265,12-1.75,14.015-1.75,16.5s2.015,4.5,4.5,4.5h14.75c2.485,0,4.5-2.015,4.5-4.5S19.985,19,17.5,19z"/></svg>
    <svg class="deco-cloud animate-float-delayed top-32 right-20 w-16 opacity-50" viewBox="0 0 24 24"><path d="M17.5,19c-3.037,0-5.5-2.463-5.5-5.5c0-0.34,0.032-0.671,0.091-0.994C11.365,11.594,10.12,11,8.75,11c-2.485,0-4.5,2.015-4.5,4.5s2.015,4.5,4.5,4.5h8.75c2.485,0,4.5-2.015,4.5-4.5s-2.015-4.5-4.5-4.5c-0.377,0-0.739,0.048-1.085,0.136C16.142,8.966,14.07,7.5,11.5,7.5c-3.037,0-5.5,2.463-5.5,5.5c0,0.34-0.032,0.671-0.091,0.994C5.165,12.594,4.12,12,2.75,12C0.265,12-1.75,14.015-1.75,16.5s2.015,4.5,4.5,4.5h14.75c2.485,0,4.5-2.015,4.5-4.5S19.985,19,17.5,19z"/></svg>
    <svg class="deco-leaf animate-float bottom-20 right-10 w-12" viewBox="0 0 24 24"><path d="M17,8C8,10,5.9,16.17,3.82,21.34L5.71,22l1-2.3A4.49,4.49,0,0,0,8,20C19,20,22,3,22,3,11,5,14,8.5,13.75,10.25,12.8,17.5,6,17,6,17S16,16,17,8Z"/></svg>

    <div class="container mx-auto px-4 py-8 flex flex-col items-center relative z-10 max-w-md bg-card backdrop-blur-md rounded-3xl shadow-xl border border-white/50">
        
        <header class="text-center mb-8 w-full relative">
            <button id="muteBtn" onclick="toggleMute()" class="absolute -top-2 right-0 text-xl opacity-50 hover:opacity-100 transition-opacity p-2">ğŸ”Š</button>
            <h1 class="text-3xl font-bold text-forest mb-2 tracking-wide">å¿ƒçµèŠ±å›­</h1>
            <p class="text-gray-500 text-sm">Mind Garden</p>
        </header>

        <div class="flex items-center justify-between w-full px-8 mb-8">
            <div class="step-dot active" id="step1"></div> <div class="step-line"></div>
            <div class="step-dot" id="step2"></div> <div class="step-line"></div>
            <div class="step-dot" id="step3"></div> <div class="step-line"></div>
            <div class="step-dot" id="step4"></div> <div class="step-line"></div>
            <div class="step-dot" id="step5"></div>
        </div>
        
        <div id="breathContainer" class="breathing-circle-container mb-8">
            <div class="breathing-circle"></div>
            <div class="circle-text flex flex-col items-center">
                <span id="phaseLabel" class="text-2xl">å‡†å¤‡</span>
                <span id="instructionText" class="text-sm font-normal opacity-70 mt-1">ç‚¹å‡»å¼€å§‹</span>
            </div>
        </div>

        <div class="text-center mb-8">
            <p class="text-5xl font-bold text-forest tabular-nums" id="timer">03:00</p>
        </div>

        <div class="flex items-center gap-4">
            <button onclick="toggleTimer()" id="mainBtn" class="bg-forest text-white px-10 py-4 rounded-full text-lg font-bold shadow-lg hover:bg-[#254228] hover:scale-105 transition-all flex items-center gap-2">
                <span id="playIcon">â–¶</span> <span id="btnText">å¼€å§‹æ”¾æ¾</span>
            </button>
            
            <button onclick="resetTimer()" class="w-14 h-14 rounded-full border-2 border-forest text-forest flex items-center justify-center hover:bg-forest hover:text-white transition-all" title="é‡ç½®">
                â†º
            </button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const PHASE_DURATION = {
            inhale: 4,  // å¸æ°” 4ç§’
            hold: 4,    // ä¿æŒ 4ç§’
            exhale: 4,  // å‘¼æ°” 4ç§’
            rest: 2     // åœé¡¿ 2ç§’
        };

        const PHASE_TEXT = {
            inhale: "å¸ æ°”",
            hold: "ä¿ æŒ",
            exhale: "å‘¼ æ°”",
            rest: "æ”¾ æ¾"
        };

        // è¯­éŸ³è„šæœ¬ï¼šå»æ‰äº†æœºæ¢°çš„é‡å¤ï¼Œåªä¿ç•™å…³é”®èŠ‚ç‚¹çš„æ¸©æŸ”å¼•å¯¼
        const GUIDE_STEPS = [
            { time: 179, text: "æ¬¢è¿æ¥åˆ°å¿ƒçµèŠ±å›­ã€‚æ‰¾ä¸€ä¸ªèˆ’é€‚çš„åå§¿ï¼Œæ”¾æ¾å…¨èº«ã€‚" },
            { time: 170, text: "è½»è½»é—­ä¸Šçœ¼ç›ã€‚æŠŠæ³¨æ„åŠ›å¸¦å›åˆ°å‘¼å¸ä¸Šã€‚" },
            { time: 160, text: "è·Ÿéšåœ†çƒçš„èŠ‚å¥ï¼Œå¸æ°”... å‘¼æ°”..." }, // åªåœ¨æœ€å¼€å§‹å¼•å¯¼ä¸€æ¬¡èŠ‚å¥
            { time: 140, text: "æ„Ÿå—ç©ºæ°”æµè¿‡é¼»å°–çš„å‡‰æ„ã€‚" },
            { time: 110, text: "å¦‚æœæ€ç»ªé£˜è¿œäº†ï¼Œæ²¡å…³ç³»ï¼Œæ¸©æŸ”åœ°æŠŠå®ƒæ‹‰å›æ¥ã€‚" },
            { time: 80, text: "æ”¾æ¾çœ‰å¤´ï¼Œæ”¾æ¾ä¸‹å·´ï¼Œè®©è‚©è†€è‡ªç„¶ä¸‹æ²‰ã€‚" },
            { time: 50, text: "ä½ å¾ˆå®‰å…¨ï¼Œæ­¤åˆ»åªæœ‰å½“ä¸‹çš„å®é™ã€‚" },
            { time: 20, text: "å‡†å¤‡ç»“æŸç»ƒä¹ ï¼Œæ…¢æ…¢åŠ¨åŠ¨æ‰‹æŒ‡å’Œè„šè¶¾ã€‚" },
            { time: 2, text: "æ…¢æ…¢çå¼€çœ¼ç›ï¼Œæ„Ÿè°¢ä½ çš„ç»ƒä¹ ã€‚" }
        ];

        // --- å˜é‡ ---
        const TOTAL_TIME_INIT = 180; // 3åˆ†é’Ÿ
        let timeRemaining = TOTAL_TIME_INIT;
        let timerInterval = null;
        let isActive = false;
        let currentPhase = 'rest';
        let phaseTimeLeft = 0;
        let isMuted = false;

        // --- DOM ---
        const timerDisplay = document.getElementById('timer');
        const phaseLabel = document.getElementById('phaseLabel');
        const instructionText = document.getElementById('instructionText');
        const breathContainer = document.getElementById('breathContainer');
        const mainBtn = document.getElementById('mainBtn');
        const btnText = document.getElementById('btnText');
        const playIcon = document.getElementById('playIcon');
        const bgMusic = document.getElementById('bgMusic');
        const muteBtn = document.getElementById('muteBtn');

        bgMusic.volume = 0.5;

        // --- é€»è¾‘ ---

        function toggleTimer() {
            if (isActive) pauseTimer();
            else startTimer();
        }

        function startTimer() {
            isActive = true;
            updateBtnUI(true);
            bgMusic.play().catch(e => console.log("éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³ä¹"));
            
            // é¦–æ¬¡å¼€å§‹
            if (timeRemaining === TOTAL_TIME_INIT) {
                switchPhase('inhale');
                checkGuide(timeRemaining); // è§¦å‘ç¬¬ä¸€å¥
            }

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay(timeRemaining);
                updateSteps(timeRemaining);
                checkGuide(timeRemaining);

                if (timeRemaining <= 0) {
                    finishSession();
                    return;
                }

                // å‘¼å¸å¾ªç¯é€»è¾‘
                phaseTimeLeft--;
                if (phaseTimeLeft <= 0) {
                    nextPhase();
                }
            }, 1000);
        }

        function pauseTimer() {
            isActive = false;
            clearInterval(timerInterval);
            updateBtnUI(false);
            bgMusic.pause();
            window.speechSynthesis.cancel();
            breathContainer.className = "breathing-circle-container"; // æš‚åœåŠ¨ç”»
            instructionText.textContent = "å·²æš‚åœ";
        }

        function resetTimer() {
            pauseTimer();
            timeRemaining = TOTAL_TIME_INIT;
            currentPhase = 'rest';
            updateTimerDisplay(TOTAL_TIME_INIT);
            phaseLabel.textContent = "å‡†å¤‡";
            instructionText.textContent = "ç‚¹å‡»å¼€å§‹";
            resetSteps();
            bgMusic.currentTime = 0;
        }

        function finishSession() {
            pauseTimer();
            phaseLabel.textContent = "å®Œæˆ";
            instructionText.textContent = "åšå¾—å¾ˆå¥½";
            updateTimerDisplay(0);
        }

        function nextPhase() {
            const sequence = ['inhale', 'hold', 'exhale', 'rest'];
            const currentIndex = sequence.indexOf(currentPhase);
            const nextIndex = (currentIndex + 1) % sequence.length;
            switchPhase(sequence[nextIndex]);
        }

        function switchPhase(phase) {
            currentPhase = phase;
            phaseTimeLeft = PHASE_DURATION[phase];
            
            // æ›´æ–°åŠ¨ç”»å’Œæ–‡å­—
            breathContainer.className = `breathing-circle-container ${phase}`;
            phaseLabel.textContent = PHASE_TEXT[phase];
            
            // é‡è¦ä¿®æ”¹ï¼šè¿™é‡Œä¸å†æœ—è¯»â€œå¸æ°”/å‘¼æ°”â€ï¼Œé¿å…å¡é¡¿å’Œæœºæ¢°æ„Ÿ
            // åªæ›´æ–°æ–‡å­—æç¤º (Instruction Text)
            if(phase === 'inhale') instructionText.textContent = "æ·±æ·±å¸æ°”...";
            else if(phase === 'hold') instructionText.textContent = "å±ä½å‘¼å¸...";
            else if(phase === 'exhale') instructionText.textContent = "ç¼“æ…¢å‘¼æ°”...";
            else instructionText.textContent = "è‡ªç„¶æ”¾æ¾...";
        }

        // --- è¯­éŸ³ä¼˜åŒ–ç‰ˆ ---
        
        function checkGuide(sec) {
            // åœ¨æ•°ç»„é‡Œæ‰¾æœ‰æ²¡æœ‰å½“å‰ç§’æ•°å¯¹åº”çš„æç¤ºè¯
            // æ³¨æ„ï¼šè¿™é‡Œç”¨ç®€å•çš„æŸ¥æ‰¾ï¼Œæ¯ç§’åªè§¦å‘ä¸€æ¬¡ï¼Œä¸ä¼šé‡å¤
            const guide = GUIDE_STEPS.find(g => g.time === sec);
            if (guide) {
                speak(guide.text);
            }
        }

        function speak(text) {
            if (isMuted) return;
            
            // 1. å…ˆåœæ­¢ä¹‹å‰çš„å£°éŸ³ï¼Œé˜²æ­¢æ’é˜Ÿé€ æˆå¡é¡¿
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            
            // 2. å°è¯•å¯»æ‰¾æ›´è‡ªç„¶çš„ Google è¯­éŸ³
            const voices = window.speechSynthesis.getVoices();
            // ä¼˜å…ˆæ‰¾ Google æ™®é€šè¯ï¼Œå…¶æ¬¡æ‰¾ä»»æ„ä¸­æ–‡
            const zhVoice = voices.find(v => v.name.includes("Google") && v.lang.includes("zh")) || 
                            voices.find(v => v.lang === 'zh-CN') || 
                            voices.find(v => v.lang.includes('zh'));
            
            if (zhVoice) {
                utterance.voice = zhVoice;
            }

            // 3. è°ƒæ•´å‚æ•°ï¼šè¯­é€Ÿç¨æ…¢ï¼ŒéŸ³è°ƒè‡ªç„¶
            utterance.rate = 0.85; // 0.85å€é€Ÿï¼Œå¬èµ·æ¥æ›´ä»å®¹
            utterance.pitch = 1;   // æ­£å¸¸éŸ³è°ƒ
            
            window.speechSynthesis.speak(utterance);
        }

        function toggleMute() {
            isMuted = !isMuted;
            muteBtn.textContent = isMuted ? "ğŸ”‡" : "ğŸ”Š";
            muteBtn.style.opacity = isMuted ? "1" : "0.5";
        }

        // --- UI æ›´æ–°è¾…åŠ© ---
        function updateTimerDisplay(seconds) {
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${m}:${s}`;
        }

        function updateBtnUI(running) {
            if (running) {
                mainBtn.classList.add('bg-accent');
                mainBtn.classList.remove('bg-forest');
                btnText.textContent = "æš‚åœ";
                playIcon.textContent = "â¸";
            } else {
                mainBtn.classList.add('bg-forest');
                mainBtn.classList.remove('bg-accent');
                btnText.textContent = timeRemaining < TOTAL_TIME_INIT ? "ç»§ç»­" : "å¼€å§‹æ”¾æ¾";
                playIcon.textContent = "â–¶";
            }
        }

        function updateSteps(sec) {
            const total = TOTAL_TIME_INIT;
            let stepIndex = 0;
            if (sec < total * 0.8) stepIndex = 1;
            if (sec < total * 0.6) stepIndex = 2;
            if (sec < total * 0.4) stepIndex = 3;
            if (sec < total * 0.2) stepIndex = 4;

            document.querySelectorAll('.step-dot').forEach((dot, idx) => {
                if (idx <= stepIndex) dot.classList.add('active');
                else dot.classList.remove('active');
            });
        }

        function resetSteps() {
            document.querySelectorAll('.step-dot').forEach(d => d.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
        }

        // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
        window.speechSynthesis.onvoiceschanged = () => {};
    </script>
</body>
</html>
